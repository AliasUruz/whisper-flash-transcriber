# .github/workflows/codex-automation.yml (Vers√£o Final: Reativa + Agendada)

name: 'Codex Automation'

# Gatilho de concorr√™ncia para garantir que apenas uma fila rode por vez.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# GATILHOS UNIFICADOS: Ouve tudo que nos interessa.
on:
  # Gatilho manual para testes.
  workflow_dispatch:

  # Gatilho agendado que roda a cada 5 minutos como garantia.
  schedule:
    - cron: '*/5 * * * *'

  # Gatilho reativo que TENTA rodar instantaneamente.
  pull_request:
    types: [opened, labeled, reopened, synchronize]

jobs:
  #############################################################
  # Job √önico: Tenta o merge instant√¢neo e garante com schedule
  #############################################################
  process_queue:
    name: 'Process Merge Queue'
    
    # CONDI√á√ÉO INTELIGENTE:
    # Roda SEMPRE se for agendado ou manual.
    # Roda SE for um PR e tiver a label "codex".
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'codex'))
      
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Checkout to stable branch'
        uses: actions/checkout@v4
        with:
          ref: 'stable'
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'List, Sort, and Process All Codex PRs'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
        run: |
          echo "Starting queue processing triggered by: ${{ github.event_name }}"
          # A l√≥gica √© sempre a mesma: processar a fila inteira.
          # Isso simplifica o c√≥digo e garante que, mesmo que um evento de PR falhe,
          # a pr√≥xima execu√ß√£o agendada ir√° consertar a situa√ß√£o.
          gh pr list --label "codex" --state "open" --base "stable" --json number,headRefName,createdAt \
          | jq -c '. | sort_by(.createdAt) | .[]' \
          | while read -r pr_json; do
              PR_NUMBER=$(echo "$pr_json" | jq -r '.number')
              PR_BRANCH=$(echo "$pr_json" | jq -r '.headRefName')
              
              echo ">>> Processing PR #${PR_NUMBER} (Branch: ${PR_BRANCH})"
              git fetch origin stable && git reset --hard origin/stable
              
              if git merge --no-ff "origin/${PR_BRANCH}" -m "Merge pull request #${PR_NUMBER} from ${PR_BRANCH}" -X theirs; then
                  echo "‚úÖ Merge successful for PR #${PR_NUMBER}."
                  git push origin stable
              else
                  echo "‚ùå Merge failed for PR #${PR_NUMBER}."
                  gh pr comment $PR_NUMBER --body "üö® **Merge Autom√°tico Falhou** üö® Conflito cr√≠tico detectado que a estrat√©gia autom√°tica n√£o conseguiu resolver."
                  continue
              fi
          done
          echo "Queue processing finished."