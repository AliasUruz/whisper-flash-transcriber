# .github/workflows/codex-automation.yml (Vers√£o com Melhorias de Robustez)

name: 'Codex Automation'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.base.ref || 'scheduled-run' }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'
  
  pull_request:
    types: [opened, labeled, reopened, synchronize]
    branches: [ 'stable', 'alpha' ]

jobs:
  process_queue:
    name: 'Process Merge Queue'
    
    # MELHORIA 1: Adiciona um timeout de 10 minutos para evitar jobs travados.
    timeout-minutes: 10
    
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'codex'))
      
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'List, Sort, and Process All Codex PRs'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          PR_BASE_REF: ${{ github.base_ref }}
        run: |
          # MELHORIA 2: Torna o script mais estrito e detalhado.
          set -euxo pipefail

          echo "Starting queue processing triggered by: $EVENT_NAME"

          TARGET_BRANCHES=""
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            TARGET_BRANCHES="$PR_BASE_REF"
          else
            TARGET_BRANCHES="stable alpha"
          fi

          echo "Processing target branches: $TARGET_BRANCHES"

          for BASE_BRANCH in $TARGET_BRANCHES; do
            echo ""
            echo "================================================================="
            echo ">>> Processing queue for branch: $BASE_BRANCH"
            echo "================================================================="

            git checkout "$BASE_BRANCH"
            git reset --hard "origin/$BASE_BRANCH"

            # Usamos 'jq --exit-status' para n√£o falhar se a lista de PRs for vazia
            # E 'read' para evitar problemas com a √∫ltima linha
            gh pr list --label "codex" --state "open" --base "$BASE_BRANCH" --json number,headRefName,createdAt \
            | jq -c '.[]' | while read -r pr_json; do
                PR_NUMBER=$(echo "$pr_json" | jq -r '.number')
                PR_BRANCH=$(echo "$pr_json" | jq -r '.headRefName')

                echo "--- Processing PR #${PR_NUMBER} into ${BASE_BRANCH} ---"

                if git merge --no-ff "origin/${PR_BRANCH}" -m "Merge pull request #${PR_NUMBER} from ${PR_BRANCH}" -X theirs; then
                    echo "‚úÖ Merge successful for PR #${PR_NUMBER}."
                    git push origin "$BASE_BRANCH"
                else
                    echo "‚ùå Merge failed for PR #${PR_NUMBER}."
                    gh pr comment $PR_NUMBER --body "üö® **Merge Autom√°tico Falhou** üö® Conflito cr√≠tico detectado em '${BASE_BRANCH}' que a estrat√©gia autom√°tica n√£o conseguiu resolver."
                    continue
                fi
            done
          done

          echo "Queue processing finished."
          
