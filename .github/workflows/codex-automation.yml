# .github/workflows/codex-automation.yml (Vers√£o 8.0: Arquitetura de 2 Jobs - Otimista + Faxineiro)

name: 'Codex Automation'

on:
  # Gatilho para o "Faxineiro" (roda a cada 15 minutos)
  schedule:
    - cron: '*/15 * * * *'
  
  # Gatilho para o "Otimista" (roda em atividade de PR)
  pull_request_target:
    types: [opened, reopened, synchronize] # Removido 'labeled' para reduzir o "ru√≠do" de gatilhos
    branches: [ 'stable', 'alpha' ]

jobs:
  #############################################################
  # Job 1: O Otimista (Tentativa de Merge Imediato e Paralelo)
  #############################################################
  optimistic_merge:
    name: 'Attempt Immediate Merge'
    # S√≥ roda em eventos de PR e se tiver a label 'codex'.
    if: github.event_name == 'pull_request_target' && contains(github.event.pull_request.labels.*.name, 'codex')
    
    runs-on: ubuntu-latest
    # FILA POR PR: Permite que m√∫ltiplos PRs rodem em paralelo sem se cancelarem.
    concurrency:
      group: ${{ github.workflow }}-optimistic-${{ github.event.pull_request.number }}
      cancel-in-progress: true
      
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Checkout Base Branch'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'Fetch, Merge, and Push Single PR'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          set -euxo pipefail
          echo "Optimistic merge attempt for PR #${PR_NUMBER}..."
          git fetch origin "refs/pull/${PR_NUMBER}/head":pr_branch
          
          if git merge pr_branch --no-ff -m "Merge pull request #${PR_NUMBER}" -X theirs; then
              echo "‚úÖ Optimistic merge successful for PR #${PR_NUMBER}."
              git push origin "${{ github.base_ref }}"
          else
              echo "‚ùå Optimistic merge failed. The scheduled job will retry."
              gh pr comment $PR_NUMBER --body "üö® Tentativa de merge imediato falhou. O merge ser√° tentado novamente no pr√≥ximo ciclo agendado."
              exit 1
          fi

  #############################################################
  # Job 2: O Faxineiro (Processador de Fila Agendado e Ordenado)
  #############################################################
  scheduled_queue_processor:
    name: 'Process Full Queue (Scheduled)'
    # S√≥ roda no evento de 'schedule'.
    if: github.event_name == 'schedule'
    
    runs-on: ubuntu-latest
    # FILA √öNICA: Garante que apenas um "faxineiro" rode por vez.
    concurrency:
      group: ${{ github.workflow }}-janitor
      cancel-in-progress: true
      
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'List, Sort, and Process Full Queue'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
        run: |
          set -euxo pipefail
          echo "Scheduled queue processing started..."
          for BASE_BRANCH in stable alpha; do
            echo ">>> Processing queue for branch: $BASE_BRANCH"
            git checkout "$BASE_BRANCH"
            git reset --hard "origin/$BASE_BRANCH"
            
            # Lista, ORDENA PELO N√öMERO (mais antigo primeiro) e processa
            gh pr list --label "codex" --state "open" --base "$BASE_BRANCH" --json number,headRefName \
            | jq -c '. | sort_by(.number) | .[]' | while read -r pr_json; do
                PR_NUM=$(echo "$pr_json" | jq -r '.number')
                
                echo "--- Processing PR #${PR_NUM} into ${BASE_BRANCH} ---"
                git fetch origin "refs/pull/${PR_NUM}/head":pr_branch
                git checkout "$BASE_BRANCH"
                git reset --hard "origin/$BASE_BRANCH"

                if git merge pr_branch --no-ff -m "Merge pull request #${PR_NUM}" -X theirs; then
                    echo "‚úÖ Scheduled merge successful for PR #${PR_NUM}."
                    git push origin "$BASE_BRANCH"
                else
                    echo "‚ùå Scheduled merge failed for PR #${PR_NUM}. It will be retried in the next cycle."
                    continue
                fi
            done
          done
          echo "Scheduled queue processing finished."