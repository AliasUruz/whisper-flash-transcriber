# .github/workflows/codex-automation.yml (Vers√£o Final: Multi-Branch - stable & alpha)

name: 'Codex Automation'

# Gatilho de concorr√™ncia para separar as filas de stable e alpha
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.base.ref || 'scheduled-run' }}
  cancel-in-progress: true

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'
  
  # Gatilho reativo que agora escuta PRs para ambas as branches
  pull_request:
    types: [opened, labeled, reopened, synchronize]
    branches: [ 'stable', 'alpha' ]

jobs:
  process_queue:
    name: 'Process Merge Queue'
    
    # Condi√ß√£o inteligente que continua funcionando para os PRs de ambas as branches
    if: >
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'codex'))
      
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'List, Sort, and Process All Codex PRs'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          # Passa a branch base do PR para o script
          PR_BASE_REF: ${{ github.base_ref }}
        run: |
          echo "Starting queue processing triggered by: $EVENT_NAME"

          # Define dinamicamente quais branches processar
          TARGET_BRANCHES=""
          if [[ "$EVENT_NAME" == "pull_request" ]]; then
            # Se for um PR, processa apenas a branch alvo do PR
            TARGET_BRANCHES="$PR_BASE_REF"
          else
            # Se for agendado ou manual, processa AMBAS as filas
            TARGET_BRANCHES="stable alpha"
          fi

          echo "Processing target branches: $TARGET_BRANCHES"

          # Loop para processar cada branch de destino
          for BASE_BRANCH in $TARGET_BRANCHES; do
            echo ""
            echo "================================================================="
            echo ">>> Processing queue for branch: $BASE_BRANCH"
            echo "================================================================="

            # Garante que estamos trabalhando na vers√£o mais recente da branch alvo
            git checkout "$BASE_BRANCH"
            git reset --hard "origin/$BASE_BRANCH"

            # Busca e processa a fila de PRs espec√≠fica para a branch atual
            gh pr list --label "codex" --state "open" --base "$BASE_BRANCH" --json number,headRefName,createdAt \
            | jq -c '. | sort_by(.createdAt) | .[]' \
            | while read -r pr_json; do
                PR_NUMBER=$(echo "$pr_json" | jq -r '.number')
                PR_BRANCH=$(echo "$pr_json" | jq -r '.headRefName')

                echo "--- Processing PR #${PR_NUMBER} into ${BASE_BRANCH} ---"

                if git merge --no-ff "origin/${PR_BRANCH}" -m "Merge pull request #${PR_NUMBER} from ${PR_BRANCH}" -X theirs; then
                    echo "‚úÖ Merge successful for PR #${PR_NUMBER}."
                    git push origin "$BASE_BRANCH"
                else
                    echo "‚ùå Merge failed for PR #${PR_NUMBER}."
                    gh pr comment $PR_NUMBER --body "üö® **Merge Autom√°tico Falhou** üö® Conflito cr√≠tico detectado em '${BASE_BRANCH}' que a estrat√©gia autom√°tica n√£o conseguiu resolver."
                    continue
                fi
            done
          done

          echo "Queue processing finished."