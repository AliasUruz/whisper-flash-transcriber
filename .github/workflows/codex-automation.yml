# .github/workflows/codex-automation.yml (Vers√£o 4.0: Robusta e Definitiva)

name: 'Codex Automation'

# CORRE√á√ÉO 1: Concorr√™ncia por BRANCH DE DESTINO para criar filas (uma para 'alpha', uma para 'stable').
concurrency:
  group: ${{ github.workflow }}-${{ github.base_ref }}
  cancel-in-progress: true

on:
  # Gatilho confi√°vel que escuta eventos de PR para as branches alvo.
  pull_request_target:
    types: [opened, labeled, reopened, synchronize]
    branches: [ 'stable', 'alpha' ]

jobs:
  auto_merge:
    name: 'Auto-Merge Codex PR'
    
    # Condi√ß√£o: S√≥ executa se o PR tiver a label 'codex'.
    if: contains(github.event.pull_request.labels.*.name, 'codex')
    
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      # CORRE√á√ÉO 3: Faz o checkout diretamente da branch de destino (ex: alpha), tornando o processo mais limpo.
      - name: 'Checkout Base Branch'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          # fetch-depth: 0 ainda √© importante para ter o hist√≥rico completo para o merge.
          fetch-depth: 0

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'Fetch, Merge, and Push'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_BRANCH_REF: "refs/pull/${{ github.event.pull_request.number }}/head"
          BASE_BRANCH: ${{ github.base_ref }}
        run: |
          set -euxo pipefail
          
          echo "Attempting to merge PR #${PR_NUMBER} into ${BASE_BRANCH}..."
          
          # Busca a refer√™ncia exata do PR para garantir que temos o c√≥digo mais atual.
          git fetch origin $PR_BRANCH_REF:pr_branch
          
          # Executa o merge com a estrat√©gia 'theirs'.
          if git merge pr_branch --no-ff -m "Merge pull request #${PR_NUMBER}" -X theirs; then
            echo "‚úÖ Merge successful."
            git push origin "$BASE_BRANCH"
            echo "Changes pushed to ${BASE_BRANCH}."
          else
            echo "‚ùå Merge failed."
            # CORRE√á√ÉO 2: Garante que um coment√°rio de falha seja postado no PR.
            gh pr comment $PR_NUMBER --body "üö® **Merge Autom√°tico Falhou** üö® Um conflito cr√≠tico foi detectado em '${BASE_BRANCH}' que a estrat√©gia autom√°tica n√£o conseguiu resolver. Interven√ß√£o manual √© necess√°ria."
            exit 1
          fi