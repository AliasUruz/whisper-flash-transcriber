# .github/workflows/codex-automation.yml (Vers√£o 7.0: Job H√≠brido √önico e Otimizado)

name: 'Codex Automation'

concurrency:
  group: ${{ github.workflow }}-${{ github.base_ref || 'scheduled-run' }}
  cancel-in-progress: true

on:
  schedule:
    - cron: '*/15 * * * *'
  
  pull_request_target:
    types: [opened, labeled, reopened, synchronize]
    branches: [ 'stable', 'alpha' ]

jobs:
  process_queue:
    name: 'Process Merge Queue'
    
    timeout-minutes: 10
    
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'pull_request_target' && contains(github.event.pull_request.labels.*.name, 'codex'))
      
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'Smartly Process PRs'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          BASE_BRANCH: ${{ github.base_ref }}
        run: |
          set -euxo pipefail
          echo "Processing started, triggered by: $EVENT_NAME"

          # --- L√ìGICA INTELIGENTE ---
          # Se o gatilho for um PR, processa apenas ele.
          if [[ "$EVENT_NAME" == "pull_request_target" ]]; then
            echo "--- Processing single PR #${PR_NUMBER} into ${BASE_BRANCH} ---"
            git checkout "$BASE_BRANCH"
            git reset --hard "origin/$BASE_BRANCH"
            git fetch origin "refs/pull/${PR_NUMBER}/head":pr_branch
            
            if git merge pr_branch --no-ff -m "Merge pull request #${PR_NUMBER}" -X theirs; then
                echo "‚úÖ Merge successful for PR #${PR_NUMBER}."
                git push origin "$BASE_BRANCH"
            else
                echo "‚ùå Merge failed for PR #${PR_NUMBER}."
                gh pr comment $PR_NUMBER --body "üö® **Merge Autom√°tico Falhou** üö® Um conflito foi detectado que n√£o p√¥de ser resolvido. Ser√° tentado novamente no pr√≥ximo ciclo agendado."
                exit 1
            fi
          
          # Se o gatilho for agendado, processa a fila inteira.
          else
            for branch in stable alpha; do
              echo ">>> Processing full queue for branch: $branch"
              git checkout "$branch"
              git reset --hard "origin/$branch"
              
              gh pr list --label "codex" --state "open" --base "$branch" --json number,headRefName --jq '.[] | .number' | while read -r num; do
                  echo "--- Processing queued PR #${num} into ${branch} ---"
                  git checkout "$branch"
                  git reset --hard "origin/$branch"
                  git fetch origin "refs/pull/${num}/head":pr_branch
                  
                  if git merge pr_branch --no-ff -m "Merge pull request #${num}" -X theirs; then
                      echo "‚úÖ Queued merge successful for PR #${num}."
                      git push origin "$branch"
                  else
                      echo "‚ùå Queued merge failed for PR #${num}. Will retry next cycle."
                      continue
                  fi
              done
            done
          fi
          echo "Processing finished."