name: Codex Merge Queue

on:
  workflow_dispatch:
  push:
    branches:
      - stable

jobs:
  process_queue:
    name: Process PR queue (oldest → newest)
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install jq and gh if needed
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq || true
          if ! command -v gh >/dev/null 2>&1; then
            # install GitHub CLI from official repo
            sudo apt-get install -y curl apt-transport-https ca-certificates gnupg lsb-release
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
              sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
              sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt-get update -y
            sudo apt-get install -y gh
          fi

      - name: Authenticate gh (use builtin token)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "$GITHUB_TOKEN" | gh auth login --with-token

      - name: Find PRs labeled "codex" (oldest → newest)
        id: find_prs
        run: |
          REPO="${GITHUB_REPOSITORY}"
          echo "Procurando PRs abertos com label 'codex'..."
          # lista PRs em JSON e ordena por createdAt (antigo -> novo)
          gh pr list --repo "$REPO" --label codex --state open --json number,createdAt,title,headRefName | \
            jq -r 'sort_by(.createdAt) | .[]?.number' > pr_list.txt || true
          # garantir arquivo existe
          touch pr_list.txt
          PR_COUNT=$(grep -cve '^\s*$' pr_list.txt || true)
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
          # exportar lista como CSV (pode não usar)
          PRS_CSV=$(paste -sd, pr_list.txt || echo "")
          echo "prs=$PRS_CSV" >> $GITHUB_OUTPUT

      - name: Process PRs (try auto-merge)
        if: steps.find_prs.outputs.pr_count != '0'
        env:
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          echo "Lendo pr_list.txt..."
          while IFS= read -r pr || [ -n "$pr" ]; do
            # pular linhas vazias
            if [ -z "$pr" ]; then
              continue
            fi
            echo "→ Processando PR #$pr"
            # tenta auto-merge (squash when checks pass)
            if gh pr merge "$pr" --repo "$REPO" --squash --auto --body "Auto-merged by Codex Merge Queue"; then
              echo "  ✅ PR #$pr merged (auto)"
            else
              echo "  ❌ Auto-merge falhou para PR #$pr — comentando e seguindo adiante"
              gh pr comment "$pr" --repo "$REPO" --body "Codex Merge Queue tentou auto-merge neste PR mas falhou. Provavelmente regras de proteção (checks faltando / branch protegido) ou conflitos impediram o merge. Por favor verifique e/ou resolva conflitos e re-acionar a fila."
            fi
          done < pr_list.txt
          echo "Processamento concluído."
