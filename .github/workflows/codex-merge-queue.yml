# .github/workflows/codex-merge-queue.yml (Vers√£o Final: Reativa a Eventos)

name: 'Codex Merge Queue'

on:
  pull_request:
    types: [opened, labeled]

jobs:
  process_queue:
    name: 'Process PR Queue'
    # CONDI√á√ÉO: Este job s√≥ roda se o PR tiver a label "codex"
    if: contains(github.event.pull_request.labels.*.name, 'codex')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Checkout to stable branch'
        uses: actions/checkout@v4
        with:
          ref: 'stable'
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'Merge the Pull Request'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          # A vari√°vel GITHUB_HEAD_REF cont√©m o nome da branch do PR que acionou o workflow
          PR_BRANCH: ${{ github.head_ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "================================================================="
          echo ">>> Processing PR #${PR_NUMBER} (Branch: ${PR_BRANCH})"
          echo "================================================================="
          
          echo "Attempting to merge ${PR_BRANCH} into stable..."
          # Usa a vari√°vel de ambiente para pegar o nome da branch do PR
          if git merge --no-ff "origin/${PR_BRANCH}" -m "Merge pull request #${PR_NUMBER} from ${PR_BRANCH}" -X theirs; then
              echo "‚úÖ Merge successful (with potential automatic conflict resolution)."
              
              echo "Pushing updated stable branch to origin..."
              git push origin stable
              
              echo "PR #${PR_NUMBER} merged and pushed successfully."

          else
              echo "‚ùå CRITICAL: Merge of PR #${PR_NUMBER} failed despite '-X theirs' strategy."
              echo "Manual intervention is required for branch ${PR_BRANCH}."
              
              gh pr comment $PR_NUMBER --body "üö® **Merge Autom√°tico Falhou** üö® Ocorreu um conflito de merge cr√≠tico que a estrat√©gia autom√°tica n√£o conseguiu resolver. Interven√ß√£o manual √© necess√°ria."
              
              # Se falhar, sa√≠mos com erro para o job ficar vermelho
              exit 1
          fi