# .github/workflows/codex-merge-queue.yml

name: 'Codex Merge Queue (Oldest to Newest)'

on:
  workflow_dispatch: # Permite que voc√™ rode este workflow manualmente pela aba "Actions"
  schedule:
    - cron: '*/15 * * * *' # Roda automaticamente a cada 15 minutos

jobs:
  process_queue:
    name: 'Process PR Queue (Oldest ‚Üí Newest)'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Checkout to stable branch'
        uses: actions/checkout@v4
        with:
          ref: 'stable'
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}

      - name: 'Install GitHub CLI'
        uses: crazy-max/gh-cli-tools-action@v3
        with:
          version: latest

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'List, Sort, and Process Codex PRs'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
        run: |
          # Lista todos os PRs do Codex, extrai n√∫mero, branch e data de cria√ß√£o em formato JSON.
          # Em seguida, usa 'jq' para ordenar os PRs do mais antigo para o mais novo.
          # O 'read' dentro do 'while' processa cada PR, um por um, na ordem correta.
          gh pr list --author "Codex" --state "open" --base "stable" --json number,headRefName,createdAt \
          | jq -c '. | sort_by(.createdAt) | .[]' \
          | while read -r pr_json; do
              PR_NUMBER=$(echo "$pr_json" | jq -r '.number')
              PR_BRANCH=$(echo "$pr_json" | jq -r '.headRefName')

              echo " "
              echo "================================================================="
              echo ">>> Processing PR #${PR_NUMBER} (Branch: ${PR_BRANCH})"
              echo "================================================================="

              # Sincroniza a branch 'stable' local para garantir que est√° atualizada
              git fetch origin stable
              git reset --hard origin/stable

              # Tenta fazer o merge da branch do PR. A flag -Xours resolve conflitos automaticamente,
              # sempre favorecendo as mudan√ßas que v√™m do PR do Codex.
              echo "Attempting to merge ${PR_BRANCH} into stable..."
              if git merge --no-ff "origin/${PR_BRANCH}" -m "Merge pull request #${PR_NUMBER} from ${PR_BRANCH}" -X ours; then
                  echo "‚úÖ Merge successful (with potential automatic conflict resolution)."
                  
                  # Empurra a 'stable' atualizada para o reposit√≥rio remoto
                  echo "Pushing updated stable branch to origin..."
                  git push origin stable
                  
                  echo "PR #${PR_NUMBER} merged and pushed successfully."

              else
                  # Se o merge falhar mesmo com -Xours (o que √© raro), reporta o erro e para.
                  echo "‚ùå CRITICAL: Merge of PR #${PR_NUMBER} failed despite '-X ours' strategy."
                  echo "Manual intervention is required for branch ${PR_BRANCH}."
                  
                  # Adiciona um coment√°rio no PR informando sobre a falha cr√≠tica
                  gh pr comment $PR_NUMBER --body "üö® **Merge Autom√°tico Falhou** üö® Ocorreu um conflito de merge cr√≠tico que a estrat√©gia autom√°tica n√£o conseguiu resolver. Interven√ß√£o manual √© necess√°ria."
                  
                  # Reseta a branch local para evitar contamina√ß√£o na pr√≥xima itera√ß√£o do loop
                  git reset --hard origin/stable
                  continue # Pula para o pr√≥ximo PR da fila
              fi
          done

      - name: 'Final Status Check'
        run: echo "Workflow finished. All open PRs in the queue have been processed."