name: Codex Merge Queue (oldest → newest)

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Branch alvo para merge (ex.: stable)"
        required: false
        default: "stable"

concurrency:
  group: codex-merge-queue
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write
  checks: write
  issues: write

env:
  PR_LABEL: codex

jobs:
  process_queue:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout repo (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gh (if not present) and ensure auth
        run: |
          set -euo pipefail
          if ! command -v gh >/dev/null 2>&1; then
            echo "Installing gh CLI..."
            sudo apt-get update -y
            sudo apt-get install -y gh
          fi
          gh auth status || true

      - name: Process PR queue (oldest → newest)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          TARGET_BRANCH: ${{ github.event.inputs.target || 'stable' }}
          PR_LABEL: ${{ env.PR_LABEL }}
        run: |
          set -euo pipefail

          # Config Git identity para committer do action
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          echo "Procurando PRs abertos com label '${PR_LABEL}' (antigo → novo)..."

          # lista os números dos PRs (um por linha)
          PRS="$(gh pr list --repo "$REPO" --label "$PR_LABEL" --state open --sort created --json number --jq '.[].number')"

          if [ -z "$PRS" ]; then
            echo "Nenhum PR encontrado com label '${PR_LABEL}'. Saindo."
            exit 0
          fi

          echo "Fila de PRs:"
          echo "$PRS"

          # processa cada PR em ordem (cada linha em PRS)
          while IFS= read -r PR || [ -n "$PR" ]; do
            [ -z "$PR" ] && continue
            echo "----------------------------------------"
            echo "Processando PR #$PR"
            echo "----------------------------------------"

            # faz checkout do PR (cria ref local)
            gh pr checkout "$PR" --repo "$REPO"
            BRANCH="$(git rev-parse --abbrev-ref HEAD || true)"
            echo "Branch do PR: ${BRANCH:-(unknown)}"

            # atualiza target branch
            git fetch origin "$TARGET_BRANCH" --depth=1 || true

            # tenta mesclar target na branch do PR preferindo as mudanças do PR (-X ours)
            set +e
            git merge -X ours --no-edit "origin/$TARGET_BRANCH"
            MERGE_EXIT=$?
            set -e

            if [ $MERGE_EXIT -ne 0 ]; then
              echo "Merge sinalizou conflitos. Vou resolver preferindo o PR (ours) arquivo a arquivo..."
            fi

            # se há conflitos, resolver preferindo o PR (ours)
            CONFLICTS="$(git ls-files -u | awk '{print $4}' | sort -u || true)"
            if [ -n "$CONFLICTS" ]; then
              echo "Arquivos em conflito: $CONFLICTS"
              for f in $CONFLICTS; do
                echo "Resolving $f (preferring PR)..."
                git checkout --ours -- "$f" 2>/dev/null || true
                if git ls-files --error-unmatch "$f" >/dev/null 2>&1; then
                  git add -- "$f"
                else
                  git rm -f -- "$f" || true
                fi
              done

              # commit se houver mudanças a commitar
              if ! git diff --cached --quiet; then
                git commit -m "chore(codex): auto-resolve conflicts preferring PR (ours)"
                echo "Pushing resolutions to origin/$BRANCH..."
                git push origin "HEAD:$BRANCH"
              else
                echo "Nada a commitar após auto-resolve."
              fi
            else
              echo "Sem conflitos após tentativa de merge."
            fi

            # tenta habilitar auto-merge (squash). Se regras de proteção bloquearem, o comando retorna erro.
            set +e
            gh pr merge "$PR" --squash --auto --repo "$REPO"
            GH_MERGE_EXIT=$?
            set -e

            if [ $GH_MERGE_EXIT -eq 0 ]; then
              echo "Auto-merge habilitado para PR #$PR."
            else
              echo "Não foi possível habilitar auto-merge para PR #$PR (provavelmente regras de proteção)."
            fi

            # comente no PR informando o que foi feito
            gh pr comment "$PR" --repo "$REPO" --body "Codex Merge Queue: mesclei 'origin/${TARGET_BRANCH}' no branch do PR preferindo o PR, resolvi conflitos remanescentes e tentei ligar auto-merge (squash)."

            echo "Finalizado PR #$PR."
            # opcional: pequena espera para deixar checks começarem
            sleep 2
          done <<< "$PRS"

          echo "Processamento da fila concluído."
