# .github/workflows/codex-merge-queue.yml (Corre√ß√£o Final da Estrat√©gia de Merge)

name: 'Codex Merge Queue (Oldest to Newest)'

on:
  workflow_dispatch:
  schedule:
    - cron: '*/15 * * * *'

jobs:
  process_queue:
    name: 'Process PR Queue (Oldest ‚Üí Newest)'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Checkout to stable branch'
        uses: actions/checkout@v4
        with:
          ref: 'stable'
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'List, Sort, and Process Codex PRs'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
        run: |
          gh pr list --label "codex" --state "open" --base "stable" --json number,headRefName,createdAt \
          | jq -c '. | sort_by(.createdAt) | .[]' \
          | while read -r pr_json; do
              PR_NUMBER=$(echo "$pr_json" | jq -r '.number')
              PR_BRANCH=$(echo "$pr_json" | jq -r '.headRefName')

              echo " "
              echo "================================================================="
              echo ">>> Processing PR #${PR_NUMBER} (Branch: ${PR_BRANCH})"
              echo "================================================================="

              git fetch origin stable
              git reset --hard origin/stable

              echo "Attempting to merge ${PR_BRANCH} into stable..."
              # CORRE√á√ÉO FINAL: Trocamos -X ours por -X theirs para sempre aceitar as mudan√ßas do PR
              if git merge --no-ff "origin/${PR_BRANCH}" -m "Merge pull request #${PR_NUMBER} from ${PR_BRANCH}" -X theirs; then
                  echo "‚úÖ Merge successful (with potential automatic conflict resolution)."
                  
                  echo "Pushing updated stable branch to origin..."
                  git push origin stable
                  
                  echo "PR #${PR_NUMBER} merged and pushed successfully."

              else
                  echo "‚ùå CRITICAL: Merge of PR #${PR_NUMBER} failed despite '-X theirs' strategy."
                  echo "Manual intervention is required for branch ${PR_BRANCH}."
                  
                  gh pr comment $PR_NUMBER --body "üö® **Merge Autom√°tico Falhou** üö® Ocorreu um conflito de merge cr√≠tico que a estrat√©gia autom√°tica n√£o conseguiu resolver. Interven√ß√£o manual √© necess√°ria."
                  
                  git reset --hard origin/stable
                  continue
              fi
          done

      - name: 'Final Status Check'
        run: echo "Workflow finished. All open PRs in the queue have been processed."