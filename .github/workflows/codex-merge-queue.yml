# .github/workflows/codex-merge-queue.yml (Com Controle de Concorr√™ncia)

name: 'Codex Merge Queue'

# MELHORIA 1: Garante que apenas uma execu√ß√£o do workflow rode por vez para a branch stable.
# Se um novo PR for criado enquanto um merge antigo est√° em progresso, o antigo ser√° cancelado.
concurrency:
  group: ${{ github.workflow }}-stable
  cancel-in-progress: true

on:
  pull_request:
    types: [opened, labeled]

jobs:
  process_queue:
    name: 'Process PR Queue'
    if: contains(github.event.pull_request.labels.*.name, 'codex')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: 'Checkout to stable branch'
        uses: actions/checkout@v4
        with:
          ref: 'stable'
          token: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          fetch-depth: 0

      - name: 'Configure Git User'
        run: |
          git config user.name "Codex Merge Bot"
          git config user.email "actions-bot@github.com"

      - name: 'Merge the Pull Request'
        env:
          GH_TOKEN: ${{ secrets.CODEX_WORKFLOW_TOKEN }}
          PR_BRANCH: ${{ github.head_ref }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "================================================================="
          echo ">>> Processing PR #${PR_NUMBER} (Branch: ${PR_BRANCH})"
          echo "================================================================="
          
          echo "Attempting to merge ${PR_BRANCH} into stable..."
          if git merge --no-ff "origin/${PR_BRANCH}" -m "Merge pull request #${PR_NUMBER} from ${PR_BRANCH}" -X theirs; then
              echo "‚úÖ Merge successful (with potential automatic conflict resolution)."
              
              echo "Pushing updated stable branch to origin..."
              git push origin stable
              
              echo "PR #${PR_NUMBER} merged and pushed successfully."

          else
              echo "‚ùå CRITICAL: Merge of PR #${PR_NUMBER} failed despite '-X theirs' strategy."
              
              gh pr comment $PR_NUMBER --body "üö® **Merge Autom√°tico Falhou** üö® Ocorreu um conflito de merge cr√≠tico que a estrat√©gia autom√°tica n√£o conseguiu resolver. Interven√ß√£o manual √© necess√°ria."
              
              exit 1
          fi